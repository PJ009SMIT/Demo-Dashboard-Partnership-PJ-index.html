<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partnership Analytics Dashboard</title>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f9fafb; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px; }
        .card-header { padding: 24px; border-bottom: 1px solid #e5e7eb; }
        .card-body { padding: 24px; }
        .title { font-size: 2rem; font-weight: bold; color: #111827; margin-bottom: 8px; }
        .subtitle { color: #6b7280; }
        .grid { display: grid; gap: 16px; }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        .metric-card { padding: 24px; border-radius: 12px; color: white; transition: transform 0.2s; }
        .metric-card:hover { transform: translateY(-2px); }
        .green { background: linear-gradient(135deg, #10b981, #059669); }
        .blue { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .purple { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .yellow { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .metric-label { opacity: 0.9; font-size: 0.875rem; margin-bottom: 8px; }
        .metric-value { font-size: 2rem; font-weight: bold; }
        .metric-sub { font-size: 0.875rem; opacity: 0.9; margin-top: 4px; }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .table th { background: #f9fafb; font-weight: 600; color: #374151; font-size: 0.75rem; text-transform: uppercase; }
        .table tr:hover { background: #f9fafb; }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; transition: all 0.2s; }
        .btn-blue { background: #3b82f6; color: white; }
        .btn-blue:hover { background: #2563eb; }
        .btn-green { background: #10b981; color: white; }
        .btn-green:hover { background: #059669; }
        .upload-area { 
            border: 2px dashed #d1d5db; 
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f9fafb;
        }
        .upload-area:hover { 
            border-color: #3b82f6; 
            background: #eff6ff;
        }
        .upload-area.dragover {
            border-color: #2563eb;
            background: #dbeafe;
        }
        .chat-container { background: #f9fafb; border-radius: 8px; padding: 16px; margin-bottom: 16px; max-height: 300px; overflow-y: auto; }
        .chat-message { display: flex; margin-bottom: 16px; }
        .chat-avatar { width: 32px; height: 32px; border-radius: 50%; margin-right: 12px; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .bot-avatar { background: #3b82f6; color: white; }
        .user-avatar { background: #10b981; color: white; }
        .chat-bubble { background: white; padding: 12px 16px; border-radius: 8px; flex: 1; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .input-group { display: flex; gap: 0; }
        .input-group input { flex: 1; padding: 12px; border: 1px solid #d1d5db; border-right: none; border-radius: 8px 0 0 8px; }
        .input-group button { border-radius: 0 8px 8px 0; }
        .trophy { color: #f59e0b; }
        .trophy-1 { color: #fbbf24; }
        .trophy-2 { color: #9ca3af; }
        .trophy-3 { color: #f97316; }
        .success { background: #d1fae5; color: #065f46; padding: 12px; border-radius: 8px; border-left: 4px solid #10b981; margin: 16px 0; }
        .info { background: #dbeafe; color: #1e40af; padding: 16px; border-radius: 8px; border-left: 4px solid #3b82f6; }
        .error { background: #fee2e2; color: #991b1b; padding: 12px; border-radius: 8px; border-left: 4px solid #ef4444; }
        .section-header { font-size: 1.125rem; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; }
        .icon { width: 20px; height: 20px; margin-right: 8px; }
        .badge { background: #10b981; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; }
        .loading { display: flex; align-items: center; justify-content: center; padding: 40px; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f4f6; border-top: 4px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .chart-bar { background: #3b82f6; height: 20px; border-radius: 4px; margin: 4px 0; position: relative; }
        .chart-container { background: white; padding: 20px; border-radius: 8px; }
        .individual-dashboard { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .grid-4 { grid-template-columns: 1fr; }
            .metric-value { font-size: 1.5rem; }
            .table { font-size: 0.875rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="card">
            <div class="card-header">
                <h1 class="title">üìä Partnership Analytics Dashboard</h1>
                <p class="subtitle">Upload your Excel file to analyze performance data instantly</p>
                <div id="fileStatus"></div>
            </div>
        </div>

        <!-- Upload Area -->
        <div class="card" id="uploadCard">
            <div class="card-body">
                <div class="upload-area" id="uploadArea">
                    <div id="uploadContent">
                        <div style="font-size: 48px; margin-bottom: 16px;">üìÅ</div>
                        <h3 style="margin-bottom: 8px;">Upload Your Excel File</h3>
                        <p style="color: #6b7280; margin-bottom: 16px;">Drag & drop or click to select (.xlsx, .xls)</p>
                        <button class="btn btn-blue">Choose File</button>
                        <p style="font-size: 0.75rem; color: #9ca3af; margin-top: 12px;">
                            Expected: Name/ID, Earnings, Commission, BV columns
                        </p>
                    </div>
                    <div id="processingContent" style="display: none;">
                        <div class="spinner"></div>
                        <p style="margin-top: 16px; font-weight: 600;">Processing your file...</p>
                        <p style="color: #6b7280; font-size: 0.875rem;">This may take a moment</p>
                    </div>
                </div>
                <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
            </div>
        </div>

        <!-- AI Chat -->
        <div class="card" id="chatCard" style="display: none;">
            <div class="card-header">
                <h2 class="section-header">
                    ü§ñ AI Data Assistant
                </h2>
                <p class="subtitle">Ask questions about your data in natural language</p>
            </div>
            <div class="card-body">
                <div class="chat-container" id="chatContainer">
                    <div class="chat-message">
                        <div class="chat-avatar bot-avatar">ü§ñ</div>
                        <div class="chat-bubble">
                            <strong>AI Assistant:</strong> Hi! I can help analyze your data. Try these commands:
                            <div style="margin-top: 12px; display: grid; gap: 8px;">
                                <button class="btn btn-blue" style="text-align: left;" onclick="askAI('top 5 performers')">üí¨ "Top 5 performers"</button>
                                <button class="btn btn-blue" style="text-align: left;" onclick="askAI('summary')">üí¨ "Give me a summary"</button>
                                <button class="btn btn-blue" style="text-align: left;" onclick="askAI('search for: [name]')">üí¨ "Search for: [name]"</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="input-group">
                    <input type="text" placeholder="Ask about your data..." id="chatInput" onkeypress="handleEnter(event)">
                    <button class="btn btn-blue" onclick="handleChat()">Send</button>
                </div>
            </div>
        </div>

        <!-- Analytics Cards -->
        <div id="analyticsCards" style="display: none;">
            <div class="grid grid-4">
                <div class="metric-card green">
                    <div class="metric-label">Total Earnings</div>
                    <div class="metric-value" id="totalEarnings">$0</div>
                    <div class="metric-sub" id="totalEarningsSub">All partners combined</div>
                </div>
                
                <div class="metric-card blue">
                    <div class="metric-label">Average Performance</div>
                    <div class="metric-value" id="avgEarnings">$0</div>
                    <div class="metric-sub" id="avgEarningsSub">Per partner</div>
                </div>
                
                <div class="metric-card purple">
                    <div class="metric-label">Total Partners</div>
                    <div class="metric-value" id="totalPartners">0</div>
                    <div class="metric-sub" id="totalPartnersSub">Active records</div>
                </div>
                
                <div class="metric-card yellow">
                    <div class="metric-label">Top Performer</div>
                    <div class="metric-value" id="topPerformer">N/A</div>
                    <div class="metric-sub" id="topPerformerSub">Leading the network</div>
                </div>
            </div>
        </div>

        <!-- Individual Dashboard -->
        <div class="card individual-dashboard" id="individualDashboard" style="display: none;">
            <div class="card-header">
                <h2 class="section-header" style="color: white;">
                    üë§ Individual Dashboard: <span id="selectedPersonName">N/A</span>
                </h2>
            </div>
            <div class="card-body">
                <div class="grid grid-4" id="individualMetrics">
                    <!-- Individual metrics will be populated here -->
                </div>
                <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid rgba(255,255,255,0.2);">
                    <h3 style="color: white; margin-bottom: 16px;">Complete Record Details</h3>
                    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));" id="completeRecord">
                        <!-- Complete record will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Chart -->
        <div class="card" id="performanceChart" style="display: none;">
            <div class="card-header">
                <h2 class="section-header">
                    üìà Top Performers Chart
                </h2>
            </div>
            <div class="card-body">
                <div class="chart-container" id="chartContainer">
                    <!-- Chart will be populated here -->
                </div>
            </div>
        </div>

        <!-- Top Performers Table -->
        <div class="card" id="topPerformersTable" style="display: none;">
            <div class="card-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 class="section-header">üèÜ Top Performers</h2>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-size: 0.875rem; color: #6b7280;">Show:</label>
                        <select id="topCountSelect" onchange="updateTopCount()" style="padding: 4px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.875rem;">
                            <option value="5">Top 5</option>
                            <option value="10">Top 10</option>
                            <option value="15">Top 15</option>
                            <option value="20">Top 20</option>
                            <option value="25">Top 25</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div style="overflow-x: auto;">
                    <table class="table" id="performersTable">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Name/ID</th>
                                <th>Earnings</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="performersTableBody">
                            <!-- Table rows will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let globalData = [];
        let columns = [];
        let topCount = 5;
        let earningsColumn = '';
        let idColumn = '';

        // File upload handling
        document.getElementById('uploadArea').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', handleFileUpload);

        // Drag and drop
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        });

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        function processFile(file) {
            if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                alert('Please upload a valid Excel file (.xlsx or .xls)');
                return;
            }

            // Show processing
            document.getElementById('uploadContent').style.display = 'none';
            document.getElementById('processingContent').style.display = 'block';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    if (jsonData.length < 2) {
                        throw new Error('File must contain at least a header row and one data row');
                    }

                    const headers = jsonData[0];
                    const rows = jsonData.slice(1).filter(row => row.some(cell => cell !== null && cell !== undefined && cell !== ''));

                    // Process data
                    const processedData = rows.map((row, index) => {
                        const rowObj = { originalIndex: index };
                        headers.forEach((header, colIndex) => {
                            let value = row[colIndex];
                            
                            // Identify ID columns
                            const isIdColumn = header && (
                                header.toString().toLowerCase().includes('id') ||
                                header.toString().toLowerCase().includes('name') ||
                                header.toString().toLowerCase().includes('partner') ||
                                header.toString().toLowerCase().includes('user') ||
                                header.toString().toLowerCase().includes('employee')
                            );

                            // Process numeric columns
                            if (!isIdColumn && value !== null && value !== undefined && value !== '') {
                                if (typeof value === 'string') {
                                    const cleanValue = value.replace(/[$,\s%]/g, '');
                                    const numValue = parseFloat(cleanValue);
                                    value = !isNaN(numValue) ? numValue : 0;
                                } else if (typeof value === 'number') {
                                    value = value;
                                } else {
                                    value = 0;
                                }
                            } else if (!isIdColumn) {
                                value = 0;
                            }

                            rowObj[header] = value;
                        });
                        return rowObj;
                    });

                    // Store global data
                    globalData = processedData;
                    columns = headers;

                    // Identify key columns
                    idColumn = headers.find(h => h && (
                        h.toLowerCase().includes('name') ||
                        h.toLowerCase().includes('id') ||
                        h.toLowerCase().includes('partner')
                    )) || headers[0];

                    earningsColumn = headers.find(h => h && (
                        h.toLowerCase().includes('earning') ||
                        h.toLowerCase().includes('revenue') ||
                        h.toLowerCase().includes('sales') ||
                        h.toLowerCase().includes('total') ||
                        h.toLowerCase().includes('commission')
                    )) || headers[1];

                    // Hide upload, show results
                    document.getElementById('uploadCard').style.display = 'none';
                    showResults(file.name, processedData.length, headers.length);

                } catch (error) {
                    alert(`Error processing file: ${error.message}`);
                    resetUpload();
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function resetUpload() {
            document.getElementById('uploadContent').style.display = 'block';
            document.getElementById('processingContent').style.display = 'none';
        }

        function showResults(fileName, recordCount, columnCount) {
            // Show success message
            document.getElementById('fileStatus').innerHTML = `
                <div class="success">
                    ‚úÖ Successfully processed <strong>${fileName}</strong><br>
                    üìä ${recordCount} records ‚Ä¢ ${columnCount} columns ‚Ä¢ Primary metric: ${earningsColumn}
                </div>
            `;

            // Show all result sections
            document.getElementById('chatCard').style.display = 'block';
            document.getElementById('analyticsCards').style.display = 'block';
            document.getElementById('performanceChart').style.display = 'block';
            document.getElementById('topPerformersTable').style.display = 'block';

            // Update analytics
            updateAnalytics();
            updateTopPerformersTable();
            updateChart();

            // Add welcome message to chat
            addBotMessage(`üéâ Great! I've analyzed your data and found ${recordCount} records. 

‚úÖ **Data Summary:**
‚Ä¢ Primary earnings column: ${earningsColumn}
‚Ä¢ ID column: ${idColumn}
‚Ä¢ Total columns: ${columnCount}

Try asking me:
‚Ä¢ "Top 10 performers"
‚Ä¢ "Summary"
‚Ä¢ "Search for: [name]"`);
        }

        function updateAnalytics() {
            if (!globalData.length || !earningsColumn) return;

            const earnings = globalData.map(row => row[earningsColumn] || 0);
            const total = earnings.reduce((sum, val) => sum + val, 0);
            const avg = total / earnings.length;
            const topPerformer = globalData
                .filter(row => row[earningsColumn] > 0)
                .sort((a, b) => (b[earningsColumn] || 0) - (a[earningsColumn] || 0))[0];

            document.getElementById('totalEarnings').textContent = `$${total.toLocaleString()}`;
            document.getElementById('avgEarnings').textContent = `$${Math.round(avg).toLocaleString()}`;
            document.getElementById('totalPartners').textContent = globalData.length;
            document.getElementById('topPerformer').textContent = topPerformer ? topPerformer[idColumn] : 'N/A';
            document.getElementById('topPerformerSub').textContent = topPerformer ? `$${topPerformer[earningsColumn].toLocaleString()}` : 'No data';
        }

        function updateTopPerformersTable() {
            if (!globalData.length || !earningsColumn) return;

            const sorted = globalData
                .filter(row => row[earningsColumn] > 0)
                .sort((a, b) => (b[earningsColumn] || 0) - (a[earningsColumn] || 0))
                .slice(0, topCount);

            const tbody = document.getElementById('performersTableBody');
            tbody.innerHTML = '';

            sorted.forEach((performer, index) => {
                const rank = index + 1;
                let trophyIcon = 'üèÖ';
                if (rank === 1) trophyIcon = 'ü•á';
                else if (rank === 2) trophyIcon = 'ü•à';
                else if (rank === 3) trophyIcon = 'ü•â';

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><span style="font-size: 1.2em;">${trophyIcon}</span> #${rank}</td>
                    <td><strong>${performer[idColumn]}</strong></td>
                    <td style="color: #059669; font-weight: bold;">$${performer[earningsColumn].toLocaleString()}</td>
                    <td><button class="btn btn-blue" onclick="showIndividual(${performer.originalIndex})">View Details</button></td>
                `;
            });
        }

        function updateChart() {
            if (!globalData.length || !earningsColumn) return;

            const topPerformers = globalData
                .filter(row => row[earningsColumn] > 0)
                .sort((a, b) => (b[earningsColumn] || 0) - (a[earningsColumn] || 0))
                .slice(0, 10);

            const maxValue = Math.max(...topPerformers.map(p => p[earningsColumn]));
            
            const chartContainer = document.getElementById('chartContainer');
            chartContainer.innerHTML = topPerformers.map((performer, index) => {
                const percentage = (performer[earningsColumn] / maxValue) * 100;
                return `
                    <div style="display: flex; align-items: center; margin-bottom: 12px;">
                        <div style="width: 120px; font-size: 0.875rem; font-weight: 500;">${performer[idColumn]}</div>
                        <div style="flex: 1; background: #f3f4f6; border-radius: 4px; height: 24px; position: relative; margin: 0 12px;">
                            <div class="chart-bar" style="width: ${percentage}%; display: flex; align-items: center; justify-content: end; padding-right: 8px; color: white; font-size: 0.75rem; font-weight: 600;">
                                ${percentage > 20 ? '$' + performer[earningsColumn].toLocaleString() : ''}
                            </div>
                        </div>
                        <div style="width: 80px; text-align: right; font-size: 0.875rem; font-weight: 600; color: #374151;">
                            ${percentage <= 20 ? '$' + performer[earningsColumn].toLocaleString() : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateTopCount() {
            topCount = parseInt(document.getElementById('topCountSelect').value);
            updateTopPerformersTable();
        }

        function showIndividual(originalIndex) {
            const person = globalData[originalIndex];
            if (!person) return;

            document.getElementById('selectedPersonName').textContent = person[idColumn];
            
            // Get numeric columns for this person
            const numericColumns = columns.filter(col => {
                const isIdColumn = col.toLowerCase().includes('id') ||
                                 col.toLowerCase().includes('name') ||
                                 col.toLowerCase().includes('partner') ||
                                 col.toLowerCase().includes('region') ||
                                 col.toLowerCase().includes('level');
                return !isIdColumn && typeof person[col] === 'number';
            });

            // Create individual metrics
            const metricsHtml = numericColumns.slice(0, 4).map(col => `
                <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 8px;">
                    <div style="opacity: 0.9; font-size: 0.875rem; margin-bottom: 8px;">${col}</div>
                    <div style="font-size: 2rem; font-weight: bold;">$${person[col].toLocaleString()}</div>
                </div>
            `).join('');

            document.getElementById('individualMetrics').innerHTML = metricsHtml;

            // Show complete record
            const recordHtml = Object.entries(person)
                .filter(([key]) => key !== 'originalIndex')
                .map(([key, value]) => `
                    <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 6px;">
                        <div style="font-size: 0.75rem; opacity: 0.8; margin-bottom: 4px;">${key}</div>
                        <div style="font-weight: 500;">${typeof value === 'number' ? value.toLocaleString() : value}</div>
                    </div>
                `).join('');

            document.getElementById('completeRecord').innerHTML = recordHtml;
            document.getElementById('individualDashboard').style.display = 'block';
            
            // Scroll to dashboard
            document.getElementById('individualDashboard').scrollIntoView({ behavior: 'smooth' });
        }

        // Chat functionality
        function addBotMessage(message) {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML += `
                <div class="chat-message">
                    <div class="chat-avatar bot-avatar">ü§ñ</div>
                    <div class="chat-bubble">
                        <div style="white-space: pre-line;">${message}</div>
                    </div>
                </div>
            `;
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addUserMessage(message) {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML += `
                <div class="chat-message" style="justify-content: flex-end;">
                    <div class="chat-bubble" style="background: #3b82f6; color: white; margin-right: 12px;">
                        ${message}
                    </div>
                    <div class="chat-avatar user-avatar">üë§</div>
                </div>
            `;
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function askAI(question) {
            document.getElementById('chatInput').value = question;
            handleChat();
        }

        function handleChat() {
            const input = document.getElementById('chatInput');
            const question = input.value.trim().toLowerCase();
            
            if (!question) return;
            if (!globalData.length) {
                addUserMessage(input.value);
                addBotMessage('Please upload an Excel file first!');
                input.value = '';
                return;
            }

            addUserMessage(input.value);

            // Process the question
            if (question.includes('top')) {
                const match = question.match(/top\s+(\d+)/);
                const count = match ? Math.min(parseInt(match[1]), globalData.length) : 5;
                
                const topPerformers = globalData
                    .filter(row => row[earningsColumn] > 0)
                    .sort((a, b) => (b[earningsColumn] || 0) - (a[earningsColumn] || 0))
                    .slice(0, count);

                let response = `üèÜ Top ${count} performers based on ${earningsColumn}:\n\n`;
                topPerformers.forEach((p, i) => {
                    const rank = i + 1;
                    const trophy = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : 'üèÖ';
                    response += `${trophy} #${rank}: ${p[idColumn]} - ${p[earningsColumn].toLocaleString()}\n`;
                });
                
                if (count !== topCount) {
                    topCount = count;
                    document.getElementById('topCountSelect').value = count;
                    updateTopPerformersTable();
                }
                
                addBotMessage(response);
                
            } else if (question.includes('search') || question.includes('find')) {
                const searchTerm = question.replace(/search|find|for|:/g, '').trim();
                const found = globalData.find(row => 
                    String(row[idColumn] || '').toLowerCase().includes(searchTerm)
                );
                
                if (found) {
                    addBotMessage(`‚úÖ Found: ${found[idColumn]}\n\nKey metrics:\n‚Ä¢ ${earningsColumn}: ${found[earningsColumn].toLocaleString()}\n\nShowing individual dashboard below.`);
                    showIndividual(found.originalIndex);
                } else {
                    addBotMessage(`‚ùå No record found for "${searchTerm}". Try searching by name or ID.`);
                }
                
            } else if (question.includes('summary') || question.includes('overview')) {
                const total = globalData.reduce((sum, row) => sum + (row[earningsColumn] || 0), 0);
                const avg = total / globalData.length;
                const topPerformer = globalData
                    .sort((a, b) => (b[earningsColumn] || 0) - (a[earningsColumn] || 0))[0];
                
                const response = `üìà Partnership Network Summary:

üè¢ Overview:
‚Ä¢ Total Partners: ${globalData.length}
‚Ä¢ Primary Metric: ${earningsColumn}

üí∞ Financial Performance:
‚Ä¢ Total ${earningsColumn}: ${total.toLocaleString()}
‚Ä¢ Average ${earningsColumn}: ${Math.round(avg).toLocaleString()}

üèÜ Top Performer:
‚Ä¢ ${topPerformer[idColumn]} - ${topPerformer[earningsColumn].toLocaleString()}`;
                
                addBotMessage(response);
                
            } else if (question.includes('help')) {
                const response = `ü§ñ AI Assistant Commands:

üîç **Search & Analysis:**
‚Ä¢ "Top 5 performers" - Show rankings
‚Ä¢ "Top 25 performers" - Custom count
‚Ä¢ "Search for: John" - Find individual
‚Ä¢ "Summary" - Complete overview

üìä **Examples:**
‚Ä¢ "Show me top 10"
‚Ä¢ "Find Sarah Johnson"
‚Ä¢ "Give me a summary"
‚Ä¢ "Top 15 earners"

üí° **Tips:**
‚Ä¢ Use person names or IDs for search
‚Ä¢ Ask for any number of top performers
‚Ä¢ Request summaries anytime`;
                
                addBotMessage(response);
                
            } else {
                addBotMessage(`ü§î I didn't understand that. Try:
‚Ä¢ "Top 5 performers"
‚Ä¢ "Search for: [name]"  
‚Ä¢ "Summary"
‚Ä¢ "Help" for more commands`);
            }

            input.value = '';
        }

        function handleEnter(event) {
            if (event.key === 'Enter') {
                handleChat();
            }
        }

        // Initialize
        console.log('‚úÖ Partnership Analytics Dashboard loaded successfully!');
    </script>
</body>
</html>
